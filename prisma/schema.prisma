generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================= ENUMS =================

enum UserRole {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  PENDING_COD
  PENDING_PAYOS
  PAID_PENDING_CONFIRM  // Thêm để khớp với Webhook PayOS
  PAID_AND_CONFIRMED
  PAID_BUT_OUT_OF_STOCK
  CANCELLED
}

// ================= CATEGORY =================

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products  Product[]

  @@index([slug])
}

// ================= USER =================

model User {
  id        Int      @id @default(autoincrement())
  phone     String   @unique
  password  String
  name      String?
  email     String?  @unique
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]
  reviews   Review[]

  @@index([role])
}

// ================= PRODUCT =================

model Product {
  id          Int       @id @default(autoincrement())
  categoryId  Int?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  name        String
  slug        String    @unique
  description String?
  unit        String    @default("Cái")
  isVisible   Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  variants    ProductVariant[]
  images      ProductImage[]
  reviews     Review[]

  @@index([categoryId])
  @@index([isVisible])
}

// ================= PRODUCT VARIANT =================

model ProductVariant {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name      String
  sku       String  @unique
  price     Int
  stock     Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems OrderItem[]

  @@index([productId])
  @@index([sku])
}

// ================= REVIEW =================

model Review {
  id        Int      @id @default(autoincrement())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
}

// ================= PRODUCT IMAGE =================

model ProductImage {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  url       String

  @@index([productId])
}

// ================= ORDER =================

model Order {
  id           Int         @id @default(autoincrement())
  orderCode    BigInt      @unique
  userId       Int?        // Đã sửa thành Int? để khách không đăng nhập vẫn mua được
  user         User?       @relation(fields: [userId], references: [id], onDelete: SetNull) // Dùng SetNull để giữ đơn hàng khi xóa User

  total        Int
  status       OrderStatus @default(PENDING)
  paymentMethod String     @default("COD") // Để biết khách chọn COD hay PAYOS

  customerName String
  phone        String
  address      String
  trackingCode String?

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  items        OrderItem[]

  @@index([userId])
  @@index([createdAt])
}

// ================= ORDER ITEM =================

model OrderItem {
  id        Int            @id @default(autoincrement())
  orderId   Int
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  variantId Int?           // Thêm ? để nếu xóa variant đơn hàng vẫn không lỗi
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  productName String         // QUAN TRỌNG: Lưu tên SP lúc mua để xem lại đơn hàng
  quantity    Int
  price       Int

  @@index([orderId])
  @@index([variantId])
}

model Contact {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String
  message   String
  status    String   @default("PENDING") // PENDING (chưa xử lý), RESOLVED (đã liên hệ)
  createdAt DateTime @default(now())
}